<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "https://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.korit.allways_back.mapper.OrderMapper">

    <insert id="insertOrder" useGeneratedKeys="true" keyProperty="orderId">
        INSERT INTO order_tb (
        user_id,
        order_number,
        total_price,
        ordered_at,
        address,
        detail_address,
        status
        ) VALUES (
        #{userId},
        #{orderNumber},
        #{totalPrice},
        NOW(),
        #{address},
        #{detailAddress},
        'READY'
        )
    </insert>

    <insert id="insertOrderDetails">
        INSERT INTO order_detail_tb (
        order_id,
        product_id,
        unit_price,
        quantity,
        set_id,
        selected_drink_id,
        selected_side_id
        )
        VALUES
        <foreach collection="items" item="item" separator=",">
            (
            #{orderId},
            #{item.productId},
            #{item.unitPrice},
            #{item.quantity},
            #{item.setId},
            #{item.selectedDrinkId},
            #{item.selectedSideId}
            )
        </foreach>
    </insert>

    <!-- ✅ 주문 내역 조회 - 이미지, 주문번호 포함 -->
    <select id="findOrderHistoryByUserId" resultType="OrderDetail">
        SELECT
        od.order_detail_id,
        od.order_id,
        od.product_id,
        od.unit_price,
        od.quantity,
        od.set_id,
        od.selected_drink_id,
        od.selected_side_id,
        o.order_number,
        o.ordered_at,
        i.item_name,
        i.size,
        img.img_url AS imgUrl,
        sm.set_name,
        d.ingredient_name AS drinkName,
        s.ingredient_name AS sideName
        FROM
        order_detail_tb od
        INNER JOIN order_tb o ON od.order_id = o.order_id
        INNER JOIN product_item_tb pi ON od.product_id = pi.product_id
        INNER JOIN item_tb i ON pi.item_id = i.item_id
        LEFT JOIN image_tb img ON i.image_id = img.image_id
        LEFT JOIN set_menu_tb sm ON od.set_id = sm.set_id
        LEFT JOIN ingredient_tb d ON od.selected_drink_id = d.ingredient_id
        LEFT JOIN ingredient_tb s ON od.selected_side_id = s.ingredient_id
        WHERE
        o.user_id = #{userId}
        ORDER BY
        o.ordered_at DESC, od.order_detail_id
    </select>

    <!-- 주문 ID로 주문 정보 조회 -->
    <select id="findOrderById" resultType="Order">
        SELECT
        order_id,
        user_id,
        order_number,
        total_price,
        ordered_at,
        address,
        detail_address
        FROM
        order_tb
        WHERE
        order_id = #{orderId}
    </select>

    <!-- 주문 ID로 주문 상세 목록 조회 -->
    <select id="findOrderDetailsByOrderId" resultType="OrderDetail">
        SELECT
        od.order_detail_id,
        od.order_id,
        od.product_id,
        od.unit_price,
        od.quantity,
        od.set_id,
        od.selected_drink_id,
        od.selected_side_id,
        i.item_name,
        i.size,
        img.img_url AS imgUrl,
        sm.set_name,
        d.ingredient_name AS drinkName,
        s.ingredient_name AS sideName
        FROM
        order_detail_tb od
        INNER JOIN product_item_tb pi ON od.product_id = pi.product_id
        INNER JOIN item_tb i ON pi.item_id = i.item_id
        LEFT JOIN image_tb img ON i.image_id = img.image_id
        LEFT JOIN set_menu_tb sm ON od.set_id = sm.set_id
        LEFT JOIN ingredient_tb d ON od.selected_drink_id = d.ingredient_id
        LEFT JOIN ingredient_tb s ON od.selected_side_id = s.ingredient_id
        WHERE
        od.order_id = #{orderId}
        ORDER BY
        od.order_detail_id
    </select>

    <!-- 주문번호로 가격 조회 -->
    <select id="findTotalPriceByOrderNumber" resultType="Integer">
        SELECT
        total_price
        FROM
        order_tb
        WHERE
        order_number = #{orderNumber}
    </select>

    <update id="updateStatus">
        UPDATE
        order_tb
        SET
        status = #{status}
        WHERE
        order_number = #{orderNumber}
    </update>
</mapper>